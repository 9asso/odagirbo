name: Build iOS App

run-name: Build iOS - ${{ inputs.app_name }}

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App folder name (e.g., frost-world-1766192023455)'
        required: true
        type: string
      code_signing_id:
        description: 'Code signing configuration ID (timestamp)'
        required: false
        type: string

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.0'
          channel: 'stable'
          cache: true
      
      - name: Verify app exists
        run: |
          if [ ! -d "apps/${{ inputs.app_name }}" ]; then
            echo "Error: App ${{ inputs.app_name }} not found"
            exit 1
          fi
          echo "Building app: ${{ inputs.app_name }}"
          ls -la "apps/${{ inputs.app_name }}"
      
      - name: Setup code signing (if provided)
        if: ${{ inputs.code_signing_id != '' }}
        run: |
          CODE_SIGNING_FILE="apps/${{ inputs.app_name }}/.code-signing/${{ inputs.code_signing_id }}.json"
          
          if [ ! -f "$CODE_SIGNING_FILE" ]; then
            echo "Error: Code signing configuration not found: $CODE_SIGNING_FILE"
            exit 1
          fi
          
          echo "Loading code signing configuration from: $CODE_SIGNING_FILE"
          
          # Extract values from JSON using jq
          PROVISIONING_PROFILE=$(cat "$CODE_SIGNING_FILE" | jq -r '.provisioningProfile')
          CERTIFICATE=$(cat "$CODE_SIGNING_FILE" | jq -r '.certificate')
          CERTIFICATE_PASSWORD=$(cat "$CODE_SIGNING_FILE" | jq -r '.certificatePassword')
          
          # Create directories
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Decode and install certificate
          echo "$CERTIFICATE" | base64 --decode > certificate.p12
          KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "" build.keychain
          # Ensure Xcode can actually find this keychain.
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k "$KEYCHAIN_PATH" -P "$CERTIFICATE_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain || echo "Warning: set-key-partition-list failed, continuing..."
          security set-keychain-settings -lut 21600 build.keychain
          
          # Decode and install provisioning profile
          echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
          # The UUID is inside the embedded plist; grep can fail depending on encoding.
          security cms -D -i profile.mobileprovision > profile.plist
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' profile.plist 2>/dev/null || true)
          if [ -z "$UUID" ]; then
            echo "Error: Could not extract UUID from provisioning profile plist"
            echo "Dumping profile plist top-level keys:"
            /usr/libexec/PlistBuddy -c 'Print' profile.plist | head -200 || true
            exit 1
          fi
          echo "Provisioning profile UUID: $UUID"
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision

          # Extract team id from provisioning profile so Xcode signing works in CI.
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' profile.plist 2>/dev/null || true)
          if [ -z "$TEAM_ID" ]; then
            TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :ApplicationIdentifierPrefix:0' profile.plist 2>/dev/null || true)
          fi
          if [ -z "$TEAM_ID" ]; then
            echo "Error: Could not extract TeamIdentifier from provisioning profile"
            exit 1
          fi
          echo "Team ID from provisioning profile: $TEAM_ID"

          # Decide signing identity type based on get-task-allow (true=development, false=distribution).
          GET_TASK_ALLOW=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:get-task-allow' profile.plist 2>/dev/null || echo "false")
          if [ "$GET_TASK_ALLOW" = "true" ]; then
            SIGN_IDENTITY="Apple Development"
          else
            SIGN_IDENTITY="Apple Distribution"
          fi
          echo "Using signing identity: $SIGN_IDENTITY (get-task-allow=$GET_TASK_ALLOW)"

          # Patch Xcode project to set DEVELOPMENT_TEAM (it is missing in generated apps).
          PBXPROJ="apps/${{ inputs.app_name }}/ios/Runner.xcodeproj/project.pbxproj"
          if [ -f "$PBXPROJ" ]; then
            echo "Patching $PBXPROJ for CI signing..."
            perl -0777 -i -pe "s/DEVELOPMENT_TEAM = [A-Z0-9]+;/DEVELOPMENT_TEAM = $TEAM_ID;/g" "$PBXPROJ"
            perl -0777 -i -pe "s/(CODE_SIGN_STYLE = Automatic;\n)/$1\t\t\t\tDEVELOPMENT_TEAM = $TEAM_ID;\n/g" "$PBXPROJ"
            perl -0777 -i -pe "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"[^\"]*\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"$SIGN_IDENTITY\";/g" "$PBXPROJ"
          else
            echo "Warning: pbxproj not found at $PBXPROJ"
          fi

          echo "Available code signing identities:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
          security find-identity -v -p codesigning || true
          
          # Clean up sensitive files
          rm certificate.p12 profile.mobileprovision profile.plist
          
          echo "Code signing configured successfully"
      
      - name: Install Flutter dependencies
        working-directory: ./apps/${{ inputs.app_name }}
        run: flutter pub get
      
      - name: Run Flutter doctor
        run: flutter doctor -v
      
      - name: Clean build
        working-directory: ./apps/${{ inputs.app_name }}
        run: flutter clean
      
      - name: Build iOS app (with codesign if configured)
        working-directory: ./apps/${{ inputs.app_name }}
        run: |
          if [ -n "${{ inputs.code_signing_id }}" ]; then
            echo "Building with code signing..."
            flutter build ios --release
          else
            echo "Building without code signing..."
            flutter build ios --release --no-codesign
          fi
      
      - name: Create IPA archive
        working-directory: ./apps/${{ inputs.app_name }}/build/ios/iphoneos
        run: |
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r -q ../../../${{ inputs.app_name }}.ipa Payload
          cd ../../..
          ls -lh ${{ inputs.app_name }}.ipa
      
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ inputs.app_name }}-${{ github.run_number }}
          path: ./apps/${{ inputs.app_name }}/${{ inputs.app_name }}.ipa
          retention-days: 30
          compression-level: 0
      
      - name: Cleanup keychain
        if: ${{ always() && inputs.code_signing_id != '' }}
        run: |
          security delete-keychain build.keychain || true
      
      - name: Build summary
        run: |
          echo "### ðŸŽ‰ iOS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App:** ${{ inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** ios-${{ inputs.app_name }}-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.code_signing_id }}" ]; then
            echo "**Code Signing:** âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Code Signing:** âš ï¸ Disabled" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the IPA from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
