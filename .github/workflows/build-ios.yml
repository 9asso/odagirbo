name: Build iOS App

run-name: Build iOS - ${{ inputs.app_name }}

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App folder name (e.g., frost-world-1766192023455)'
        required: true
        type: string
      code_signing_id:
        description: 'Optional: subfolder under apps/<app_name>/.code-signing/ (defaults to root .code-signing/)'
        required: false
        type: string
        default: ''

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.0'
          channel: 'stable'
          cache: true
      
      - name: Verify app exists
        run: |
          if [ ! -d "apps/${{ inputs.app_name }}" ]; then
            echo "Error: App ${{ inputs.app_name }} not found"
            exit 1
          fi
          echo "Building app: ${{ inputs.app_name }}"
          ls -la "apps/${{ inputs.app_name }}"
      
      - name: Setup code signing (required)
        working-directory: ./apps/${{ inputs.app_name }}
        run: |
          set -euo pipefail

          SIGN_DIR=".code-signing"
          if [ -n "${{ inputs.code_signing_id }}" ]; then
            SIGN_DIR=".code-signing/${{ inputs.code_signing_id }}"
          fi

          CERT_PATH="$SIGN_DIR/certificate.p12"
          PROFILE_PATH="$SIGN_DIR/profile.mobileprovision"
          CERT_PASSWORD_PATH="$SIGN_DIR/certificate_password.txt"

          if [ ! -f "$CERT_PATH" ] || [ ! -f "$PROFILE_PATH" ] || [ ! -f "$CERT_PASSWORD_PATH" ]; then
            echo "Error: Missing code signing files. Expected:" 
            echo "- $CERT_PATH"
            echo "- $PROFILE_PATH"
            echo "- $CERT_PASSWORD_PATH"
            exit 1
          fi

          CERT_PASSWORD=$(cat "$CERT_PASSWORD_PATH")
          echo "::add-mask::$CERT_PASSWORD"
          echo "CERTIFICATE_PASSWORD=$CERT_PASSWORD" >> $GITHUB_ENV

          KEYCHAIN_PASSWORD=$(python3 -c 'import secrets; print(secrets.token_urlsafe(18))')
          echo "::add-mask::$KEYCHAIN_PASSWORD"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
          
          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          security cms -D -i "$PROFILE_PATH" > profile.plist
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' profile.plist 2>/dev/null || true)
          if [ -z "$UUID" ]; then
            echo "Error: Could not extract UUID from provisioning profile"
            exit 1
          fi
          cp "$PROFILE_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision

          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' profile.plist 2>/dev/null || true)
          if [ -z "$PROFILE_NAME" ]; then
            echo "Error: Could not extract Name from provisioning profile"
            exit 1
          fi
          
          # Extract signing info from provisioning profile
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' profile.plist 2>/dev/null || true)
          PROFILE_APP_ID=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' profile.plist 2>/dev/null || true)
          
          # Determine signing certificate name from profile type
          GET_TASK_ALLOW=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:get-task-allow' profile.plist 2>/dev/null || echo "false")
          if [ "$GET_TASK_ALLOW" = "true" ]; then
            SIGNING_CERTIFICATE="Apple Development"
          else
            SIGNING_CERTIFICATE="Apple Distribution"
          fi
          
          # Extract bundle ID from provisioning profile
          BUNDLE_ID="${PROFILE_APP_ID#${TEAM_ID}.}"
          
          # Export environment variables for later steps
          echo "SIGNING_CERTIFICATE=$SIGNING_CERTIFICATE" >> $GITHUB_ENV
          echo "TEAM_IDENTIFIER=$TEAM_ID" >> $GITHUB_ENV
          echo "UUID=$UUID" >> $GITHUB_ENV
          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
          
          # Create keychain and import certificate
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import "$CERT_PATH" -k ~/Library/Keychains/build.keychain -P "$CERT_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s ~/Library/Keychains/build.keychain
          security set-keychain-settings -lut 21600 ~/Library/Keychains/build.keychain
          security find-identity -p codesigning -v
          
          rm profile.plist

      - name: Unlock keychain
        run: |
          security unlock-keychain -p "${{ env.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/build.keychain

      - name: Configure keychain for codesigning
        run: |
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ env.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/build.keychain

      - name: Install Flutter dependencies
        working-directory: ./apps/${{ inputs.app_name }}
        run: flutter pub get

      - name: Build iOS app (no codesign)
        working-directory: ./apps/${{ inputs.app_name }}
        run: |
          cd ios
          pod install
          cd ..
          flutter build ios --release --no-codesign

      - name: Patch Xcode project for manual signing
        working-directory: ./apps/${{ inputs.app_name }}
        run: |
          PBXPROJ="ios/Runner.xcodeproj/project.pbxproj"
          cp "$PBXPROJ" "$PBXPROJ.backup"
          
          # Add PROVISIONING_PROFILE_SPECIFIER to pbxproj using Python
          python3 - "${{ env.PROFILE_NAME }}" "$PBXPROJ" <<'PYSCRIPT'
          import sys

          profile_name = sys.argv[1]
          pbxproj_path = sys.argv[2]

          with open(pbxproj_path, "r", encoding="utf-8") as f:
            lines = f.readlines()

          new_lines = []
          in_release = False
          for idx, line in enumerate(lines):
            new_lines.append(line)

            if "/* Release */ = {" in line:
              in_release = True

            if in_release and "buildSettings = {" in line:
              window = lines[idx:idx + 25]
              already = any("PROVISIONING_PROFILE_SPECIFIER" in l for l in window)
              if not already:
                new_lines.append(f'\t\t\t\tPROVISIONING_PROFILE_SPECIFIER = "{profile_name}";\n')
              in_release = False

          with open(pbxproj_path, "w", encoding="utf-8") as f:
            f.writelines(new_lines)
          PYSCRIPT

      - name: Create Entitlements File
        working-directory: ./apps/${{ inputs.app_name }}
        run: |
          cat > ios/Runner/Runner.entitlements <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>aps-environment</key>
              <string>production</string>
            </dict>
          </plist>
          EOF

      - name: Sign iOS app with xcodebuild
        working-directory: ./apps/${{ inputs.app_name }}
        run: |
          cd build/ios/iphoneos
          xcodebuild -workspace $GITHUB_WORKSPACE/apps/${{ inputs.app_name }}/ios/Runner.xcworkspace \
             -scheme Runner \
             -configuration Release \
             -sdk iphoneos \
             -archivePath $PWD/Runner.xcarchive \
             clean archive \
             CODE_SIGN_IDENTITY="${{ env.SIGNING_CERTIFICATE }}" \
             CODE_SIGN_STYLE=Manual \
             DEVELOPMENT_TEAM="${{ env.TEAM_IDENTIFIER }}"

      - name: Create Export Options Plist
        working-directory: ./apps/${{ inputs.app_name }}
        run: |
          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <plist version="1.0">
              <dict>
                  <key>method</key>
                  <string>app-store</string>
                  <key>teamID</key>
                  <string>${{ env.TEAM_IDENTIFIER }}</string>
                  <key>provisioningProfiles</key>
                  <dict>
                      <key>${{ env.BUNDLE_ID }}</key>
                      <string>${{ env.PROFILE_NAME }}</string>
                  </dict>
                  <key>signingStyle</key>
                  <string>manual</string>
                  <key>signingCertificate</key>
                  <string>${{ env.SIGNING_CERTIFICATE }}</string>
                  <key>appThinning</key>
                  <string>false</string>
                  <key>destination</key>
                  <string>export</string>
                  <key>uploadSymbols</key>
                  <true/>
                  <key>bitcode</key>
                  <string>disable</string>
                  <key>includeProvisioningProfiles</key>
                  <true/>
              </dict>
          </plist>
          EOF

      - name: Create IPA Package
        working-directory: ./apps/${{ inputs.app_name }}
        run: |
          cd build/ios/iphoneos
          xcodebuild -exportArchive \
            -archivePath $PWD/Runner.xcarchive \
            -exportPath $GITHUB_WORKSPACE/apps/${{ inputs.app_name }} \
            -exportOptionsPlist $GITHUB_WORKSPACE/apps/${{ inputs.app_name }}/ios/ExportOptions.plist
          
          # Find and rename the IPA
          IPA_FILE=$(find $GITHUB_WORKSPACE/apps/${{ inputs.app_name }} -maxdepth 1 -name "*.ipa" | head -1)
          if [ -n "$IPA_FILE" ]; then
            mv "$IPA_FILE" "$GITHUB_WORKSPACE/apps/${{ inputs.app_name }}/${{ inputs.app_name }}.ipa"
          fi

      - name: Upload iOS build logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-logs-${{ inputs.app_name }}-${{ github.run_number }}
          path: |
            ./apps/${{ inputs.app_name }}/ios/ExportOptions.plist
            ./apps/${{ inputs.app_name }}/build/ios/iphoneos/Runner.xcarchive
          if-no-files-found: warn
          retention-days: 7
      
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ inputs.app_name }}-${{ github.run_number }}
          path: ./apps/${{ inputs.app_name }}/${{ inputs.app_name }}.ipa
          retention-days: 30
          compression-level: 0
      
      - name: Cleanup keychain
        if: ${{ always() }}
        run: |
          security delete-keychain build.keychain || true
      
      - name: Build summary
        run: |
          echo "### ðŸŽ‰ iOS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App:** ${{ inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** ios-${{ inputs.app_name }}-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Code Signing:** âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the IPA from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
